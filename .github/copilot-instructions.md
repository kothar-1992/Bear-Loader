# Copilot / AI coding assistant instructions

Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

- Must-know high-level architecture:
  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)
  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)
  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))
  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- Critical flows and constraints (do not change lightly):
  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.
  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.
  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- HWID & Secure storage:
  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.
  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.

- OTA / Downloads:
  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.
  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

- Network & error patterns:
  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.
# Copilot / AI coding assistant instructions

Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

- Must-know high-level architecture:
  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)
  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)
  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))
  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- Critical flows and constraints (do not change lightly):
  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.
  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.
  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- HWID & Secure storage:
  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.
  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.

- OTA / Downloads:
  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.
  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

- Network & error patterns:
  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.
````instructions
<!-- Copilot instructions for Bear-Loader repository -->
# Copilot / AI coding assistant instructions

Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

- Must-know high-level architecture:
  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)
  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)
  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))
  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- Critical flows and constraints (do not change lightly):
  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.
  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.
  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- HWID & Secure storage:
  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.
  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.

- OTA / Downloads:
  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.
  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

- Network & error patterns:
  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.

````````instructions
<!-- Copilot instructions for Bear-Loader repository -->
# Copilot / AI coding assistant instructions

Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

- Must-know high-level architecture:
  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)
  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)
  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))
  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- Critical flows and constraints (do not change lightly):
  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.
  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.
  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- HWID & Secure storage:
  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.
  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.

- OTA / Downloads:
  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.
  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

- Network & error patterns:
  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.

````````instructions
<!-- Copilot instructions for Bear-Loader repository -->
# Copilot / AI coding assistant instructions

Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

- Must-know high-level architecture:
  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)
  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)
  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))
  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- Critical flows and constraints (do not change lightly):
  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.
  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.
  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- HWID & Secure storage:
  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.
  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.

- OTA / Downloads:
  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.
  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

- Network & error patterns:
  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.

````````instructions
<!-- Copilot instructions for Bear-Loader repository -->
# Copilot / AI coding assistant instructions
````instructions
<!-- Copilot instructions for Bear-Loader repository -->
# Copilot / AI coding assistant instructions

Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

- Must-know high-level architecture:
  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)
  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)
  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))
  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- Critical flows and constraints (do not change lightly):
  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.
  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.
  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- HWID & Secure storage:
  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.
  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.

- OTA / Downloads:
  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.
  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

- Network & error patterns:
  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.

````
- Project purpose: Android KeyAuth v1.3 loader app. Main entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.
- Key configuration: `app/src/main/java/com/bearmod/loader/config/KeyAuthConfig.kt` — update API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH when working with authentication flows.
- Network factory: `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` — creates Retrofit/OkHttp clients. OTA uses a separate long-timeout client; OTA base URLs are dynamic.

````instructions
<!-- Copilot instructions for Bear-Loader repository -->
# Copilot / AI coding assistant instructions

Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

- Must-know high-level architecture:
  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)
  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)
  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))
  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- Critical flows and constraints (do not change lightly):
  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.
  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.
  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- HWID & Secure storage:
  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.
  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.

- OTA / Downloads:
  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.
  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

- Network & error patterns:
  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.

````

