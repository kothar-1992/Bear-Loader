# GitHub Copilot Instructions for Bear-Loader# Copilot / AI coding assistant instructions



## Project OverviewKeep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

Android KeyAuth v1.3 loader app with Material Design UI, secure authentication, OTA updates, and hardware fingerprinting.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

**Entry Points**: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt`, `MainActivity.kt`

- Must-know high-level architecture:

## Architecture (Critical Understanding)  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)

  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)

**Data Flow**: UI (Activity/ViewModel) → Repository → API Service → Network    - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))

**Storage**: `SecurePreferences.kt` (Android Keystore AES/GCM + fallback)    - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

**Network**: `NetworkFactory.kt` creates regular + OTA long-timeout clients  

**HWID**: Pluggable providers (`AndroidHWIDProvider` = MD5 of Build properties)- Critical flows and constraints (do not change lightly):

  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.

## Critical KeyAuth Flows (DO NOT BREAK)  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.

  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

1. **Initialization Sequence** (immutable):

   - `KeyAuthRepository.initialize()` MUST run before any auth calls- HWID & Secure storage:

   - NEVER pass stored session tokens to `initialize()` (prevents "session not found" errors)  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.

   - Follow init → response.success pattern from C++ library v1.3  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.



2. **Session Recovery** (fragile):- OTA / Downloads:

   - On "session not found": `SecurePreferences.clearSessionToken()` then reset in-memory `sessionId`  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.

   - See `LoginActivity.clearCorruptedSessionData()` + `KeyAuthRepository` session handling  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.



3. **HWID Validation**:- Network & error patterns:

   - Generated once, stored as `device_hwid` via `SecurePreferences`  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

   - MD5 fingerprint of `Build` properties (deterministic across app launches)

- Build, tests, and common commands (Windows PowerShell):

## Configuration & Network  - Build debug APK: `./gradlew assembleDebug`

  - Run unit tests: `./gradlew test`

**KeyAuth Config**: `app/src/main/java/com/bearmod/loader/config/KeyAuthConfig.kt`  - Run instrumentation: `./gradlew connectedAndroidTest`

- Expected values: `APP_NAME="com.bearmod.loader"`, `OWNER_ID="yLoA9zcOEF"`, `API_BASE_URL` → keyauth.win/api/1.3/  - Run lint baseline: `./gradlew lint`

- Custom hash validation in `KeyAuthRepository.validateConfiguration()`

- Project-specific conventions / quick anchors:

**Network Patterns**: All API calls return `NetworkResult<T>` wrappers (Success/Error/Loading)  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)

  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding

## Common Commands (Windows PowerShell)  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)

```powershell  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH

./gradlew assembleDebug        # Build APK  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

./gradlew test                 # Unit tests  

./gradlew connectedAndroidTest # Instrumentation tests- PR guidance & safe changes:

./gradlew lint                 # Update lint baseline  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.

```  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.



## Testing GuidanceIf anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.

# Copilot / AI coding assistant instructions

**Unit Tests**: Mock `HWIDProvider` and `KeystoreProvider` (avoid Android deps)  

**Integration Tests**: Use Robolectric for `SecurePreferences` + HWID persistence  Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

**Key Test Files**: `app/src/test/` + `README-HWID.md` examples

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

## File Quick Reference

- Must-know high-level architecture:

- `KeyAuthRepository.kt` — Core auth (init, authenticateWithLicense, restoreSession)  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)

- `SecurePreferences.kt` — Keystore encryption, Base64 wrapping, fallback handling    - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)

- `NetworkFactory.kt` — HTTP clients (regular vs OTA timeouts)  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))

- `OTARepository.kt` — Streaming downloads + SHA-256 verification  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- `AGENT.md` — Duplicate logic analysis & refactor plan

- `MIGRATION_PLAN_KEYAUTH.md` — Storage migration guidelines- Critical flows and constraints (do not change lightly):

  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.

## Safe Change Guidelines  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.

  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- **Auth/Session**: Minimal changes only. Add `PreferencesMigration.kt` for storage format changes

- **Configuration**: Validate via `KeyAuthRepository.validateConfiguration()` - HWID & Secure storage:

- **Dependencies**: Check `gradle/libs.versions.toml` for version constraints  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.

- **Storage**: Preserve Keystore fallback behavior in `SecurePreferences`  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.



## Avoid These Mistakes- OTA / Downloads:

  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.

❌ Passing stored tokens to `initialize()`    - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

❌ Changing KeyAuth init sequence without C++ v1.3 compatibility  

❌ Breaking HWID determinism across app restarts  - Network & error patterns:

❌ Removing encryption fallback paths    - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

❌ Large auth refactors without incremental tests
- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.
````instructions
<!-- Copilot instructions for Bear-Loader repository -->
# Copilot / AI coding assistant instructions

Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

- Must-know high-level architecture:
  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)
  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)
  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))
  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- Critical flows and constraints (do not change lightly):
  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.
  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.
  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- HWID & Secure storage:
  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.
  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.

- OTA / Downloads:
  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.
  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

- Network & error patterns:
  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.

````````instructions
<!-- Copilot instructions for Bear-Loader repository -->
# Copilot / AI coding assistant instructions

Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

- Must-know high-level architecture:
  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)
  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)
  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))
  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- Critical flows and constraints (do not change lightly):
  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.
  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.
  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- HWID & Secure storage:
  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.
  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.

- OTA / Downloads:
  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.
  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

- Network & error patterns:
  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.

````````instructions
<!-- Copilot instructions for Bear-Loader repository -->
# Copilot / AI coding assistant instructions

Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

- Must-know high-level architecture:
  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)
  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)
  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))
  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- Critical flows and constraints (do not change lightly):
  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.
  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.
  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- HWID & Secure storage:
  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.
  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.

- OTA / Downloads:
  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.
  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

- Network & error patterns:
  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.

````````instructions
<!-- Copilot instructions for Bear-Loader repository -->
# Copilot / AI coding assistant instructions
````instructions
<!-- Copilot instructions for Bear-Loader repository -->
# Copilot / AI coding assistant instructions

Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

- Must-know high-level architecture:
  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)
  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)
  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))
  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- Critical flows and constraints (do not change lightly):
  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.
  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.
  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- HWID & Secure storage:
  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.
  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.

- OTA / Downloads:
  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.
  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

- Network & error patterns:
  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.

````
- Project purpose: Android KeyAuth v1.3 loader app. Main entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.
- Key configuration: `app/src/main/java/com/bearmod/loader/config/KeyAuthConfig.kt` — update API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH when working with authentication flows.
- Network factory: `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` — creates Retrofit/OkHttp clients. OTA uses a separate long-timeout client; OTA base URLs are dynamic.

````instructions
<!-- Copilot instructions for Bear-Loader repository -->
# Copilot / AI coding assistant instructions

Keep this short and actionable — focus on the app's auth lifecycle, secure storage, HWID, OTA, and Android build/test flows.

- Purpose: Android KeyAuth v1.3 loader app. Main UI entry points: `app/src/main/java/com/bearmod/loader/ui/LoginActivity.kt` and `MainActivity.kt`.

- Must-know high-level architecture:
  - UI layer (Activity/ViewModel) -> `KeyAuthRepository` (auth, session) and `OTARepository` (updates)
  - Network clients created in `app/src/main/java/com/bearmod/loader/network/NetworkFactory.kt` (regular vs OTA long-timeout client)
  - Encrypted storage via `app/src/main/java/com/bearmod/loader/utils/SecurePreferences.kt` (Keystore AES/GCM, Base64(wrapped IV+ciphertext))
  - HWID provider is pluggable (see `README-HWID.md` and AndroidHWIDProvider tests)

- Critical flows and constraints (do not change lightly):
  - KeyAuth initialization: `KeyAuthRepository.initialize()` MUST run before any license/auth calls. The code uses an init -> response.success pattern; preserve sequencing.
  - NEVER pass stored session tokens into the `initialize()` call — the repo explicitly avoids this to prevent "session not found" init failures.
  - On server "session not found" errors, clear persistent session with `SecurePreferences.clearSessionToken()` and then reset in-memory `sessionId` (see `LoginActivity` + `KeyAuthRepository`).

- HWID & Secure storage:
  - HWID is generated by a provider (MD5 fingerprint of Build properties by default) and stored under `device_hwid` via `SecurePreferences`.
  - `SecurePreferences` implements Keystore-based AES/GCM and falls back to an unencrypted pref name if Keystore init fails. Preserve this fallback when changing storage.

- OTA / Downloads:
  - OTA endpoints and streaming downloads live in `app/src/main/java/com/bearmod/loader/data/api/OTAApiService.kt` and `OTARepository.kt`.
  - Use streaming `downloadFile()` and verify SHA-256 hashes (see `OTARepository.downloadVariant()`). Use `NetworkFactory.createOTAOkHttpClient()` for long timeouts.

- Network & error patterns:
  - Retrofit suspend functions return `NetworkResult` wrappers (Success/Error/Loading). Follow existing error mapping and logging conventions.

- Build, tests, and common commands (Windows PowerShell):
  - Build debug APK: `./gradlew assembleDebug`
  - Run unit tests: `./gradlew test`
  - Run instrumentation: `./gradlew connectedAndroidTest`
  - Run lint baseline: `./gradlew lint`

- Project-specific conventions / quick anchors:
  - `KeyAuthRepository.kt` — core auth sequence (init, authenticateWithLicense, restoreSession)
  - `SecurePreferences.kt` — encryption, store/clear helpers, Base64 encoding
  - `NetworkFactory.kt` — different OkHttp clients (normal vs OTA)
  - `KeyAuthConfig.kt` — API_BASE_URL, APP_NAME, OWNER_ID, CUSTOM_HASH
  - `README-HWID.md` — testing guidance for HWID providers and Robolectric tests

- PR guidance & safe changes:
  - Keep auth/session changes minimal. If changing storage formats add a `PreferencesMigration.kt` path and tests.
  - Small, well-scoped diffs are preferred. Add unit tests under `app/src/test` for new behavior.

If anything here is unclear or you need examples (small refactors, tests, or reproduction steps), say which area to expand and I will add a short recipe.

````

